name: ðŸ”‘ Credentials & Secrets Detection

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  detect-secrets:
    name: ðŸ” Detect Exposed Secrets
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ” Check for .env file in repo
        run: |
          echo "## ðŸ” Environment File Check" >> $GITHUB_STEP_SUMMARY
          
          if [ -f ".env" ]; then
            echo "âŒ **CRITICAL:** .env file found in repository!" >> $GITHUB_STEP_SUMMARY
            echo "This file should be in .gitignore and NOT committed." >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "âœ… No .env file in repository (correct)" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f ".env.example" ]; then
            echo "âœ… .env.example found (template file - OK)" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ðŸ” Check for hardcoded IPs
        run: |
          echo "## ðŸŒ Hardcoded IP Check" >> $GITHUB_STEP_SUMMARY
          
          # Buscar IPs privadas hardcodeadas (excluyendo comentarios y ejemplos)
          if grep -r -E "([0-9]{1,3}\.){3}[0-9]{1,3}" lib/ --include="*.dart" | grep -v "//.*[0-9]" | grep -v "192.168\|127.0.0.1\|localhost" > ips.txt 2>/dev/null; then
            echo "âš ï¸ Potential hardcoded IPs found:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            cat ips.txt >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… No hardcoded IPs detected" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ðŸ” Check for API keys patterns
        run: |
          echo "## ðŸ”‘ API Key Pattern Check" >> $GITHUB_STEP_SUMMARY
          
          # Patrones comunes de API keys
          PATTERNS=(
            "api[_-]?key['\"]?\s*[:=]\s*['\"][a-zA-Z0-9]{20,}"
            "secret[_-]?key['\"]?\s*[:=]\s*['\"][a-zA-Z0-9]{20,}"
            "access[_-]?token['\"]?\s*[:=]\s*['\"][a-zA-Z0-9]{20,}"
            "auth[_-]?token['\"]?\s*[:=]\s*['\"][a-zA-Z0-9]{20,}"
          )
          
          FOUND=0
          for pattern in "${PATTERNS[@]}"; do
            if grep -r -i -E "$pattern" lib/ --include="*.dart" 2>/dev/null; then
              FOUND=1
            fi
          done
          
          if [ $FOUND -eq 1 ]; then
            echo "âŒ Potential API keys or tokens found!" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "âœ… No API key patterns detected" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ðŸ” Check for Android keystore files
        run: |
          echo "## ðŸ¤– Android Keystore Check" >> $GITHUB_STEP_SUMMARY
          
          if find android/ -name "*.keystore" -o -name "*.jks" | grep -q .; then
            echo "âŒ **CRITICAL:** Keystore files found in repository!" >> $GITHUB_STEP_SUMMARY
            echo "These files contain signing credentials and must NOT be committed." >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "âœ… No keystore files in repository" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ðŸ” Check for local.properties
        run: |
          echo "## ðŸ“± Local Configuration Check" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "android/local.properties" ]; then
            echo "âŒ **WARNING:** local.properties found in repository!" >> $GITHUB_STEP_SUMMARY
            echo "This file contains local paths and should be in .gitignore." >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "âœ… No local.properties in repository" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ðŸ” Check for Firebase config files
        run: |
          echo "## ðŸ”¥ Firebase Configuration Check" >> $GITHUB_STEP_SUMMARY
          
          FIREBASE_FILES=0
          
          if [ -f "android/app/google-services.json" ]; then
            echo "âš ï¸ google-services.json found" >> $GITHUB_STEP_SUMMARY
            FIREBASE_FILES=1
          fi
          
          if [ -f "ios/Runner/GoogleService-Info.plist" ]; then
            echo "âš ï¸ GoogleService-Info.plist found" >> $GITHUB_STEP_SUMMARY
            FIREBASE_FILES=1
          fi
          
          if [ $FIREBASE_FILES -eq 1 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Note:** Firebase config files detected. Ensure they don't contain sensitive data." >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… No Firebase configuration files found" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ðŸ“Š Security Score
        if: always()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸŽ¯ Security Checklist Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… All credential checks passed!" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”’ Repository is safe to be public" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Scanned at:** $(date -u)" >> $GITHUB_STEP_SUMMARY
